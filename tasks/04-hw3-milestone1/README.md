# Домашнее Задание 3

## Сроки сдачи

* Срок сдачи в качестве маленькой домашки `hw3-m1` --- до **27 ноября 23:59:59.(9) МСК** включительно
* Срок сдачи в качестве большой домашки `hw3` --- до **11 декабря 23:59:59.(9) МСК** включительно

## Задача

Добавить новую функциональность - подписки на других пользователей и лента постов.
Любой пользователь может подписаться на другого пользователя. Подписаться на самого себя нельзя.

Лента - это упорядоченный по времени публикации список всех постов от других пользователей, на которые подписался текущий авторизованный.
Отписываться в нашей системе пока нельзя.

Более формально:

- Необходимо реализовать эндпоинт ``POST /api/v1/users/{userId}/subscribe``
  Он добавляет текущему авторизованному пользователю новую подписку.
- Необходимо реализовать эндпоинт ``GET /api/v1/subscriptions``
  Он возвращает идентификаторы всех пользователей, на который подписался текущий.
- Необходимо реализовать эндпоинт ``GET /api/v1/subscribers``
  Он возвращает идентификаторы всех пользователей, которые подписались на текущего.
- Необходимо реализовать эндпоинт ``GET /api/v1/feed``
  Возвращает список постов из ленты пользователя. Интерфейс коммуникации с этим эндпоинтом точно такой же как и у ``/api/v1/users/{userId}/posts``
  (То есть такой же формат выдачи и такой же способ организации страниц)
- Не забудьте, что система все еще поддерживает два эндпоинта для добавления и редактирования постов. Их вызовы должны оказывать влияние на соответствующие ленты пользователей.

Обновленную спецификацию OpenAPI можно найти в [microblog.yaml](./microblog.yaml).

ВАЖНО:

Отображение ленты - это не самая тривиальная задача и наивный алгоритм при большом количестве подписчиков 
перестанет эффективно работать. На наших масштабах такую проблему сложно будет заметить, 
но мы с вами разрабатываем сервис сразу на вырост, 
поэтому решение должно включать в себя фоновую обработку перестроения ленты.

Для этих целей вам будет выдан Redis как самый простой и удобный для использования брокер сообщений.
При запуске тестов ваш код будет запущено в виде двух сервисов: 

- веб-сервер, который будет принимать http запросы
- воркер, который будет обрабатывать фоновые задачи.

Различить, какой сервис сейчас запускается, можно будет по переменной окружения `APP_MODE`.

В связи с тем, что обработка в фоне означает eventual consistency, в тестах этот момент будет учтен ---
тесты сделают небольшую паузу в критические моменты, чтобы процессы в системе имели время сойтись.

## Рекоммендации

- Заранее продумайте схемы в базе данных - какие коллекции вам нужны, какие индексы нужно построить и тд.

- Используйте готовые инструменты для реализации обработки очередей. Например, рекомендуется ознакомиться с
  примером реализации очереди на Redis & Go с прошлого кода: [код](https://github.com/hse-system-design/public/tree/year-2021/15-queues-more/task-queue)
  и [видео-разбор](https://youtu.be/0oNnkb8X744?t=55).

## Формат сдачи


- Сервис должен быть оформлен в виде **приватного** git-репозитория в организации [hse-system-design](https://github.com/hse-system-design)
  с реализацией на Go. В корне репозитория должен находиться ``Dockerfile``, описывающий образ сервиса.

- При запуске Docker-образа сервис должен автоматически стартовать в соответствии с установленными переменными
  окружения:

    - `APP_MODE` --- режим запуска сервиса. Возможные значения:
        - `SERVER` --- сервис должен запустить http сервер
        - `WORKER` --- сервис должен запустить воркер
    - `SERVER_PORT` --- номер порта, на котором должен быть доступен API
    - `MONGO_URL` --- адрес для подключения к MongoDB
    - `MONGO_DBNAME` --- название базы данных, которую можно использовать для хранения.
    - `REDIS_URL` --- адрес для подключения к Redis

- Критерий сдачи --- успешная сборка Jenkins-джобы http://51.250.71.53/job/hw3-milestone1/
  (логин `student` пароль `student1234!`)

- Успешную сборку нужно сохранить, нажав кнопку "Хранить эту сборку вечно",
  и (опционально) загрузить в форму https://forms.gle/ZW79KQb9fT8XcZ596 
  (проверить, что вы заполнили форму, можно по этой [таблице](https://docs.google.com/spreadsheets/d/11BQNTqvKwFumB0ae7IUSYwFcQ0E43Z5npOZkQ_WTEAA/edit?usp=sharing))